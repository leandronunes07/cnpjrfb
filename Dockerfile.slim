# Dockerfile.slim - Optimized for CNPJ Project (Production)
FROM debian:12
LABEL maintainer="bjverde@yahoo.com.br"

ENV DEBIAN_FRONTEND noninteractive
ENV TIMEZONE America/Sao_Paulo

# 1. System Updates & Essential Tools
RUN apt-get update && apt-get upgrade -y && \
    apt-get -y install \
    wget \
    curl \
    lsb-release \
    ca-certificates \
    apt-transport-https \
    software-properties-common \
    zip \
    unzip \
    vim \
    rpl \
    locales \
    git-core \
    && apt-get clean

# 2. Add PHP Repository (Sury)
RUN wget -O /etc/apt/trusted.gpg.d/php.gpg https://packages.sury.org/php/apt.gpg && \
    echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" | tee /etc/apt/sources.list.d/php.list && \
    apt-get update

# 3. Timezone Configuration
RUN ln -fs /usr/share/zoneinfo/${TIMEZONE} /etc/localtime && \
    apt-get install -y --no-install-recommends tzdata && \
    dpkg-reconfigure --frontend noninteractive tzdata

# 4. Install PHP 8.2 & Extensions (Minimal Set for Adianti + MySQL/Postgres)
# Removed: sqlsrv, pdo_sqlsrv, mongodb, xdebug
RUN apt-get -y install \
    apache2 \
    libapache2-mod-php8.2 \
    php8.2 \
    php8.2-cli \
    php8.2-common \
    php8.2-opcache \
    php8.2-curl \
    php8.2-dom \
    php8.2-xml \
    php8.2-zip \
    php8.2-soap \
    php8.2-intl \
    php8.2-xsl \
    php8.2-mbstring \
    php8.2-gd \
    php8.2-pdo \
    php8.2-pdo-sqlite \
    php8.2-sqlite3 \
    php8.2-pdo-mysql \
    php8.2-mysql \
    php8.2-pdo-pgsql \
    php8.2-pgsql \
    php8.2-ldap \
    php8.2-ssh2 \
    openssl

# 5. Apache Configuration
RUN a2dismod mpm_event && \
    a2dismod mpm_worker && \
    a2enmod mpm_prefork && \
    a2enmod rewrite && \
    a2enmod php8.2 && \
    a2enmod authnz_ldap && \
    a2enmod ldap && \
    LANG="en_US.UTF-8" rpl "AllowOverride None" "AllowOverride All" /etc/apache2/apache2.conf

# 6. Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# 7. Install PHPUnit (Optional for Prod, kept for compatibility)
RUN wget -O /usr/local/bin/phpunit-11.phar https://phar.phpunit.de/phpunit-11.phar && \
    chmod +x /usr/local/bin/phpunit-11.phar && \
    ln -s /usr/local/bin/phpunit-11.phar /usr/local/bin/phpunit

# 8. Cleanup
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# 9. Setup
RUN updatedb
EXPOSE 80
EXPOSE 443

CMD ["apachectl", "-D", "FOREGROUND"]
